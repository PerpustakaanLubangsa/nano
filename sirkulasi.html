<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sirkulasi</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
--bg-page: #f8fafd;
--bg-surface: #ffffff;
--text-main: #1f1f1f;
--text-sub: #444746;
--brand: #1a73e8;
--border: #dee1e5;
--input-bg: #f0f4f9;
--item-hover: #f1f3f4;
--danger: #d93025;
--tag-bg: rgba(26, 115, 232, 0.1);
--shimmer: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
}
@media (prefers-color-scheme: dark) {
:root {
--bg-page: #000000;
--bg-surface: #121212;
--text-main: #e3e3e3;
--text-sub: #9aa0a6;
--brand: #8ab4f8;
--border: #303134;
--input-bg: #1e1f20;
--item-hover: #2d2e30;
--danger: #f28b82;
--tag-bg: rgba(138, 180, 248, 0.15);
}
}
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
font-family: 'Plus Jakarta Sans', sans-serif;
background-color: var(--bg-page);
color: var(--text-main);
display: flex;
justify-content: center;
height: 100vh;
overflow: hidden;
}
.app-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; position: relative; }
.scroll-area {
flex: 1;
overflow-y: auto;
padding: 24px 20px 180px 20px;
scrollbar-width: none;
}
.scroll-area::-webkit-scrollbar { display: none; }
.selected-member-tag {
display: inline-flex;
align-items: center;
gap: 8px;
background: var(--brand);
color: #000;
padding: 6px 14px;
border-radius: 100px;
font-size: 11px;
font-weight: 800;
margin-bottom: 12px;
margin-left: 16px;
animation: slideUp 0.2s ease;
}
@keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.bottom-nav {
position: fixed;
bottom: 0;
left: 50%;
transform: translateX(-50%);
width: 100%;
max-width: 500px;
padding: 12px 0;
background: var(--bg-page);
z-index: 100;
}
.input-wrapper {
margin: 0 16px;
display: flex;
align-items: center;
background: var(--input-bg);
border-radius: 100px;
padding: 0 20px;
height: 48px;
border: 1px solid var(--border);
}
.input-gemini {
flex: 1;
background: transparent;
border: none;
font-family: inherit;
font-size: 14px;
color: var(--text-main);
outline: none;
}
.results-list {
position: absolute;
bottom: 100%;
left: 16px;
right: 16px;
display: flex;
flex-direction: column-reverse;
gap: 6px;
margin-bottom: 8px;
max-height: 70vh;
overflow-y: auto;
padding-bottom: 4px;
scrollbar-width: none;
}
.results-list::-webkit-scrollbar { display: none; }
.result-item {
padding: 12px 16px;
cursor: pointer;
background: var(--bg-surface);
border: 1px solid var(--border);
border-radius: 16px;
display: flex;
flex-direction: column;
gap: 4px;
content-visibility: auto;
contain-intrinsic-size: 60px;
}
.result-item.selected { background: var(--item-hover); border-color: var(--brand); }
.res-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
.res-title { font-size: 13px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.res-sub { font-size: 11px; font-weight: 600; color: var(--brand); }
.res-tags { display: flex; gap: 4px; overflow: hidden; }
.tag {
padding: 2px 8px;
background: var(--tag-bg);
color: var(--brand);
font-size: 10px;
font-weight: 700;
border-radius: 6px;
white-space: nowrap;
}
.skeleton {
background: var(--input-bg);
height: 60px;
border-radius: 16px;
position: relative;
overflow: hidden;
border: 1px solid var(--border);
margin-bottom: 6px;
}
.skeleton::after {
content: "";
position: absolute;
top: 0; left: 0; right: 0; bottom: 0;
background: var(--shimmer);
animation: shimmer 1.5s infinite;
}
@keyframes shimmer { 100% { transform: translateX(100%); } }
.hidden { display: none !important; }
</style>
</head>
<body>
<div class="app-container">
<div class="scroll-area">
<div id="status-msg" style="text-align: center; font-size: 12px; opacity: 0.5; margin-top: 50px;"></div>
</div>
<div class="bottom-nav">
<div id="mainResults" class="results-list"></div>
<div id="memberTag" class="selected-member-tag hidden">
<span id="tagName"></span>
<span onclick="resetUI()" style="cursor:pointer; opacity:0.6; padding-left:4px">âœ•</span>
</div>
<div class="input-wrapper">
<input type="text" id="mainInput" class="input-gemini" placeholder="Cari Siswa..." autocomplete="off" autofocus>
</div>
</div>
</div>
<script type="module">
import { supabase as client } from './supa/supa.js';
let state = { member: null, mode: 'SEARCH', selectedIdx: -1, lastQuery: '', activeLoans: [] };
async function getMembers() {
const cached = localStorage.getItem('cache_members_v2');
if (cached) return JSON.parse(cached);
const { data, error } = await client.from('anggota').select('id, nis, nama, jenjang, kamar, organisasi');
if (error) return [];
if (data) {
localStorage.setItem('cache_members_v2', JSON.stringify(data));
return data;
}
return [];
}
function getBooksCache() {
const cached = localStorage.getItem('cache_books_permanent');
return cached ? JSON.parse(cached) : [];
}
function saveBooksCache(newBooks) {
const current = getBooksCache();
const bookMap = new Map(current.map(b => [b.kode, b]));
newBooks.forEach(b => bookMap.set(b.kode, b));
localStorage.setItem('cache_books_permanent', JSON.stringify(Array.from(bookMap.values())));
}
async function getActiveLoans() {
const { data } = await client.from('sirkulasi').select('member_id, kode_eksemplar, judul_buku').eq('status', 'DIPINJAM');
state.activeLoans = data || [];
}
function showSkeleton() {
mainResults.innerHTML = Array(3).fill('<div class="skeleton"></div>').join('');
}
const mainInput = document.getElementById('mainInput');
const mainResults = document.getElementById('mainResults');
mainInput.addEventListener('input', async () => {
const q = mainInput.value.toLowerCase().trim();
if (q === state.lastQuery) return;
state.lastQuery = q;
state.selectedIdx = -1;
if (q.length < 2) { mainResults.innerHTML = ''; return; }
if (state.mode === 'SEARCH') {
const members = await getMembers();
const filtered = members.filter(m => {
const loan = state.activeLoans.find(l => l.member_id === m.id);
return m.nama.toLowerCase().includes(q) || 
m.nis.includes(q) || 
(m.kamar && m.kamar.toLowerCase().includes(q)) || 
(m.organisasi && m.organisasi.toLowerCase().includes(q)) ||
(loan && loan.kode_eksemplar.toLowerCase().includes(q));
});
renderResults(filtered, 'MEMBER');
const directMatch = filtered.find(m => m.nis === q || (state.activeLoans.find(l => l.member_id === m.id && l.kode_eksemplar.toLowerCase() === q)));
if (directMatch) {
state.selectedIdx = 0;
updateSelection(mainResults.querySelectorAll('.result-item'));
}
} else {
const localBooks = getBooksCache().filter(b => 
b.judul.toLowerCase().includes(q) || 
b.kode.toLowerCase().includes(q)
);
if (localBooks.length > 5) {
renderResults(localBooks, 'BOOK');
const exactBook = localBooks.find(b => b.kode.toLowerCase() === q);
if (exactBook) { state.selectedIdx = 0; updateSelection(mainResults.querySelectorAll('.result-item')); }
} else {
showSkeleton();
const { data: eks } = await client.from('ekslempar').select('id, kode, biblio_id, status, lokasi_rak').or(`kode.ilike.%${q}%`).limit(20);
let results = [];
if (eks && eks.length > 0) {
const { data: bib } = await client.from('biblio').select('id, judul, penulis').in('id', eks.map(e => e.biblio_id));
results = eks.map(e => ({ ...e, ...bib.find(b => b.id === e.biblio_id) }));
} else {
const { data: bibSearch } = await client.from('biblio').select('id, judul, penulis').ilike('judul', `%${q}%`).limit(20);
if (bibSearch?.length > 0) {
const { data: eksSearch } = await client.from('ekslempar').select('id, kode, biblio_id, status, lokasi_rak').in('biblio_id', bibSearch.map(b => b.id));
results = eksSearch.map(e => ({ ...e, ...bibSearch.find(b => b.id === e.biblio_id) }));
}
}
saveBooksCache(results);
const finalBooks = getBooksCache().filter(b => 
b.judul.toLowerCase().includes(q) || 
b.kode.toLowerCase().includes(q)
);
renderResults(finalBooks, 'BOOK');
const exactBook = finalBooks.find(b => b.kode.toLowerCase() === q);
if (exactBook) { state.selectedIdx = 0; updateSelection(mainResults.querySelectorAll('.result-item')); }
}
}
});
function renderResults(data, type) {
mainResults.innerHTML = '';
const fragment = document.createDocumentFragment();
data.forEach((item, idx) => {
const div = document.createElement('div');
div.className = 'result-item';
div.dataset.index = idx;
if (type === 'MEMBER') {
const loan = state.activeLoans.find(l => l.member_id === item.id);
div.innerHTML = `
<div class="res-row">
<span class="res-title" style="color:${loan ? 'var(--danger)' : 'inherit'}">${item.nama}</span>
<span class="res-sub">${item.nis}</span>
</div>
${loan ? `<div class="res-row" style="margin-top:2px"><span style="font-size:10px; color:var(--danger); font-weight:600">${loan.judul_buku} (${loan.kode_eksemplar})</span></div>` : ''}
<div class="res-tags">
<span class="tag">${item.kamar || '-'}</span>
<span class="tag">${item.organisasi || '-'}</span>
<span class="tag">${item.jenjang || '-'}</span>
</div>`;
div.onclick = () => {
if (loan) {
sessionStorage.setItem('pending_loan', JSON.stringify({ member: item, book: { kode: loan.kode_eksemplar }, direct: true }));
window.location.href = 'detail_sirkulasi.html';
} else {
selectMember(item);
}
};
} else {
const isAvailable = (item.status || 'Tersedia').toLowerCase() === 'tersedia';
div.style.opacity = isAvailable ? '1' : '0.6';
div.innerHTML = `
<div class="res-row">
<span class="res-title">${item.judul}</span>
<span class="res-sub">${item.kode}</span>
</div>
<div class="res-row">
<div class="res-tags"><span class="tag">${item.penulis || 'Tanpa Penulis'}</span></div>
<div class="res-tags">
<span class="tag">${item.lokasi_rak || '-'}</span>
<span class="tag" style="color:${isAvailable ? '#00c853' : '#d93025'}">${item.status || 'Tersedia'}</span>
</div>
</div>`;
div.onclick = () => selectBuku(item);
}
fragment.appendChild(div);
});
mainResults.appendChild(fragment);
}
mainInput.addEventListener('keydown', (e) => {
const items = mainResults.querySelectorAll('.result-item');
if (e.key === 'Enter') {
if (state.selectedIdx > -1 && items[state.selectedIdx]) {
items[state.selectedIdx].click();
} else if (items.length === 1) {
items[0].click();
}
return;
}
if (!items.length) return;
if (e.key === 'ArrowUp') {
e.preventDefault();
state.selectedIdx = Math.min(state.selectedIdx + 1, items.length - 1);
updateSelection(items);
} else if (e.key === 'ArrowDown') {
e.preventDefault();
state.selectedIdx = Math.max(state.selectedIdx - 1, 0);
updateSelection(items);
}
});
function updateSelection(items) {
items.forEach((item, idx) => {
item.classList.toggle('selected', idx === state.selectedIdx);
if (idx === state.selectedIdx) item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
});
}
function selectMember(m) {
state.member = m; state.mode = 'BOOK';
state.lastQuery = '';
mainInput.value = ''; mainInput.placeholder = 'Cari Kode atau Judul Buku...';
mainResults.innerHTML = '';
document.getElementById('memberTag').classList.remove('hidden');
document.getElementById('tagName').innerText = m.nama;
mainInput.focus();
}
function selectBuku(b) {
if ((b.status || 'Tersedia').toLowerCase() !== 'tersedia') {
alert('Maaf, buku ini sedang dipinjam atau tidak tersedia.');
return;
}
sessionStorage.setItem('pending_loan', JSON.stringify({
member: state.member,
book: b
}));
window.location.href = 'detail_sirkulasi.html';
}
window.resetUI = () => {
sessionStorage.removeItem('pending_loan');
location.reload();
};
getActiveLoans();
getMembers();
mainInput.focus();
</script>
</body>
</html>